<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Bookings - Customer - Rent-a-Car</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="../css/style.css" />
  </head>
  <body class="my-bookings-page">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand" href="../../index.html">
          <i class="bi bi-car-front-fill me-2"></i>
          Rent-a-Car
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="user-dashboard.html">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="available-cars.html">Available Cars</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="my-bookings.html">My Bookings</a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item">
              <button class="btn btn-outline-light logout-btn">
                <i class="bi bi-box-arrow-right me-1"></i> Logout
              </button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page header -->
    <div class="my-bookings-page-header">
      <div class="mb-icon-wrap">
        <i class="bi bi-calendar-check-fill"></i>
      </div>
      <h1>My Bookings</h1>
      <p class="mb-subtitle">View your booking history and current reservations</p>
    </div>

    <!-- Content -->
    <div class="container my-bookings-container">
      <!-- Stats pills -->
      <div class="mb-stats-row" id="mbStatsRow">
        <div class="mb-stat-pill mb-stat-total">
          <div>
            <div class="mb-stat-num" id="myBookingsCount">0</div>
            <div class="mb-stat-label">Total</div>
          </div>
        </div>
        <div class="mb-stat-pill mb-stat-approved">
          <div>
            <div class="mb-stat-num" id="approvedBookings">0</div>
            <div class="mb-stat-label">Approved</div>
          </div>
        </div>
        <div class="mb-stat-pill mb-stat-pending">
          <div>
            <div class="mb-stat-num" id="pendingBookingsUser">0</div>
            <div class="mb-stat-label">Pending</div>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div class="mb-loading" id="mbLoading">
        <div class="spinner-border mb-2" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mb-0">Loading your bookings...</p>
      </div>

      <!-- Bookings list (cards) -->
      <div class="mb-bookings-list d-none" id="userBookingsList">
        <!-- Filled by JS -->
      </div>

      <!-- Empty state -->
      <div class="mb-empty-state d-none" id="mbEmptyState">
        <div class="mb-empty-icon"><i class="bi bi-calendar-x"></i></div>
        <h5>No bookings yet</h5>
        <p>You haven't made any bookings. Browse our cars and book your first ride.</p>
        <a href="available-cars.html" class="btn btn-primary">
          <i class="bi bi-car-front me-2"></i>Browse Available Cars
        </a>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/script.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser || currentUser.role !== "user") {
          window.location.href = "../login.html";
          return;
        }

        loadUserBookings();

        const logoutBtn = document.querySelector(".logout-btn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", function () {
            localStorage.removeItem("currentUser");
            window.location.href = "../login.html";
          });
        }

        updateDashboardStats();
      });

      function loadUserBookings() {
        try {
          const currentUser = JSON.parse(localStorage.getItem("currentUser"));
          if (!currentUser) return;

          const bookings = JSON.parse(localStorage.getItem("bookings")) || [];
          const cars = JSON.parse(localStorage.getItem("cars")) || [];
          const userBookings = bookings.filter((b) => b.userId === currentUser.id);

          const listEl = document.getElementById("userBookingsList");
          const loadingEl = document.getElementById("mbLoading");
          const emptyEl = document.getElementById("mbEmptyState");

          loadingEl.classList.add("d-none");
          listEl.classList.add("d-none");
          emptyEl.classList.add("d-none");

          if (userBookings.length === 0) {
            emptyEl.classList.remove("d-none");
            return;
          }

          listEl.innerHTML = "";
          listEl.classList.remove("d-none");

          userBookings.sort(
            (a, b) => new Date(b.createdAt || b.id) - new Date(a.createdAt || a.id)
          );

          userBookings.forEach((booking) => {
            const car = cars.find((c) => c.id === booking.carId);
            const startDate = new Date(booking.startDate).toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
              year: "numeric",
            });
            const endDate = new Date(booking.endDate).toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
              year: "numeric",
            });

            let badgeClass = "pending";
            let badgeLabel = "Pending";
            switch (booking.status) {
              case "approved":
                badgeClass = "approved";
                badgeLabel = "Approved";
                break;
              case "rejected":
                badgeClass = "rejected";
                badgeLabel = "Rejected";
                break;
              case "completed":
                badgeClass = "completed";
                badgeLabel = "Completed";
                break;
              case "cancelled":
                badgeClass = "cancelled";
                badgeLabel = "Cancelled";
                break;
            }

            const today = new Date();
            const start = new Date(booking.startDate);
            const end = new Date(booking.endDate);
            let statusNote = "";
            if (booking.status === "approved") {
              if (today < start) statusNote = "Upcoming";
              else if (today >= start && today <= end) statusNote = "Ongoing";
              else if (today > end) statusNote = "Completed";
            }

            let actionsHtml = "";
            if (booking.status === "pending") {
              actionsHtml = `
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="cancelBooking(${booking.id})">
                  <i class="bi bi-x-circle me-1"></i>Cancel
                </button>`;
            }
            if (booking.status === "approved") {
              actionsHtml += `
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="viewBookingDetails(${booking.id})">
                  <i class="bi bi-eye me-1"></i>View
                </button>`;
            }

            const card = document.createElement("div");
            card.className = "mb-booking-card";
            card.innerHTML = `
              <div class="mb-booking-card-inner">
                <div class="mb-booking-main">
                  <div class="mb-booking-car">${car ? car.name : "Unknown Car"}</div>
                  <div class="mb-booking-meta">${car ? `${car.model} · ${car.type}` : "—"}</div>
                  <div class="mb-booking-dates">
                    <i class="bi bi-calendar3"></i>
                    ${startDate} – ${endDate}
                  </div>
                  <div class="mb-booking-price">$${(booking.totalPrice || 0).toFixed(2)}</div>
                </div>
                <div class="mb-booking-side">
                  <span class="mb-booking-badge ${badgeClass}">${badgeLabel}</span>
                  ${statusNote ? `<small class="text-muted">${statusNote}</small>` : ""}
                  <div class="mb-booking-actions">${actionsHtml}</div>
                </div>
              </div>`;
            listEl.appendChild(card);
          });
        } catch (error) {
          console.error("Error loading user bookings:", error);
          showAlert("Error loading bookings. Please try again.", "danger");
          document.getElementById("mbLoading").classList.add("d-none");
          document.getElementById("mbEmptyState").classList.remove("d-none");
        }
      }

      function updateDashboardStats() {
        try {
          const currentUser = JSON.parse(localStorage.getItem("currentUser"));
          if (!currentUser) return;

          const bookings = JSON.parse(localStorage.getItem("bookings")) || [];
          const userBookings = bookings.filter((b) => b.userId === currentUser.id);

          document.getElementById("myBookingsCount").textContent = userBookings.length;
          document.getElementById("approvedBookings").textContent = userBookings.filter(
            (b) => b.status === "approved"
          ).length;
          document.getElementById("pendingBookingsUser").textContent = userBookings.filter(
            (b) => b.status === "pending"
          ).length;
        } catch (error) {
          console.error("Error updating dashboard stats:", error);
        }
      }

      function cancelBooking(bookingId) {
        if (!confirm("Are you sure you want to cancel this booking?")) return;
        try {
          const bookings = JSON.parse(localStorage.getItem("bookings")) || [];
          const idx = bookings.findIndex((b) => b.id === bookingId);
          if (idx === -1) return;

          bookings[idx].status = "cancelled";
          localStorage.setItem("bookings", JSON.stringify(bookings));
          showAlert("Booking cancelled successfully!", "success");
          setTimeout(() => {
            loadUserBookings();
            updateDashboardStats();
          }, 1000);
        } catch (error) {
          console.error("Error cancelling booking:", error);
          showAlert("Error cancelling booking. Please try again.", "danger");
        }
      }

      function viewBookingDetails(bookingId) {
        const bookings = JSON.parse(localStorage.getItem("bookings")) || [];
        const cars = JSON.parse(localStorage.getItem("cars")) || [];
        const users = JSON.parse(localStorage.getItem("users")) || [];

        const booking = bookings.find((b) => b.id === bookingId);
        if (!booking) {
          showAlert("Booking details not found!", "danger");
          return;
        }

        const car = cars.find((c) => c.id === booking.carId);
        const user = users.find((u) => u.id === booking.userId);
        const shortId = booking.id.toString().slice(-6);

        const modalHtml = `
          <div class="modal fade" id="bookingDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title d-flex align-items-center gap-2">
                    <span class="booking-modal-icon"><i class="bi bi-calendar-check"></i></span>
                    Booking #${shortId}
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="row g-4">
                    <div class="col-md-6">
                      <h6>Car</h6>
                      <p class="mb-0 text-primary fw-semibold">${car ? car.name : "N/A"}</p>
                      <p class="mb-0 small text-secondary">${car ? `${car.model} · ${car.type}` : "—"}</p>
                    </div>
                    <div class="col-md-6">
                      <h6>Status &amp; total</h6>
                      <p class="mb-1">
                        <span class="mb-booking-badge ${booking.status}">${booking.status}</span>
                      </p>
                      <p class="mb-0 fw-bold text-primary">$${(booking.totalPrice || 0).toFixed(2)}</p>
                    </div>
                    <div class="col-md-6">
                      <h6>Dates</h6>
                      <p class="mb-0">${new Date(booking.startDate).toLocaleDateString()} – ${new Date(booking.endDate).toLocaleDateString()}</p>
                      <p class="mb-0 small text-secondary">Booked on ${new Date(booking.createdAt).toLocaleDateString()}</p>
                    </div>
                    <div class="col-md-6">
                      <h6>Duration</h6>
                      <p class="mb-0">${booking.duration || "N/A"}</p>
                    </div>
                  </div>
                  ${
                    booking.status === "approved"
                      ? `
                  <div class="alert alert-info mt-4 mb-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Your booking is confirmed. Please collect the car from our office on the start date.
                  </div>`
                      : ""
                  }
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                  ${
                    booking.status === "approved"
                      ? `<button type="button" class="btn btn-primary"><i class="bi bi-printer me-1"></i>Print Receipt</button>`
                      : ""
                  }
                </div>
              </div>
            </div>
          </div>`;

        document.body.insertAdjacentHTML("beforeend", modalHtml);
        const modalEl = document.getElementById("bookingDetailsModal");
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
        modalEl.addEventListener("hidden.bs.modal", function () {
          this.remove();
        });
      }

      function showAlert(message, type) {
        document.querySelectorAll(".alert-fixed").forEach((a) => a.remove());
        const el = document.createElement("div");
        el.className = `alert alert-${type} alert-fixed alert-dismissible fade show`;
        el.style.cssText = "position:fixed;top:20px;right:20px;z-index:9999;min-width:300px;box-shadow:0 4px 12px rgba(0,0,0,0.3);";
        el.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 5000);
      }

      window.refreshBookings = function () {
        loadUserBookings();
        updateDashboardStats();
      };
    </script>
  </body>
</html>
