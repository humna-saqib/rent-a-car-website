<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Available Cars - Rent-a-Car</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../css/style.css" />
  </head>
  <body class="available-cars-page">
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand" href="../../index.html">
          <i class="bi bi-car-front-fill me-2"></i>
          Rent-a-Car
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="user-dashboard.html">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="available-cars.html"
                >Available Cars</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="my-bookings.html">My Bookings</a>
            </li>
          </ul>
          <ul class="navbar-nav">
            <li class="nav-item">
              <button
                type="button"
                class="btn btn-outline-light btn-sm logout-btn"
              >
                Logout
              </button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <header class="av-header">
      <div class="av-header-inner container">
        <div class="av-header-icon" aria-hidden="true">
          <i class="bi bi-car-front-fill"></i>
        </div>
        <h1 class="av-header-title">Available Cars</h1>
        <p class="av-header-desc">Choose a car and book in a few clicks</p>
        <p class="av-header-count" id="avCarsCount">
          <span id="avCarsCountNum">0</span> cars available
        </p>
      </div>
    </header>

    <main class="av-main container">
      <div class="row g-4" id="availableCars">
        <!-- Cards or empty state injected here -->
      </div>
    </main>

    <div
      class="modal fade"
      id="bookingModal"
      tabindex="-1"
      aria-labelledby="bookingModalTitle"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content av-modal-content">
          <div class="modal-header av-modal-header">
            <h5 class="modal-title" id="bookingModalTitle">
              <i class="bi bi-calendar-plus me-2"></i>Book:
              <span id="bookingCarName"></span>
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body av-modal-body">
            <form id="bookingForm">
              <input type="hidden" id="bookingCarId" name="carId" />
              <div class="row g-3">
                <div class="col-6">
                  <label for="startDate" class="form-label">Start date</label>
                  <input
                    type="date"
                    class="form-control"
                    id="startDate"
                    required
                  />
                </div>
                <div class="col-6">
                  <label for="endDate" class="form-label">End date</label>
                  <input
                    type="date"
                    class="form-control"
                    id="endDate"
                    required
                  />
                </div>
              </div>
              <div class="mt-3">
                <label for="durationType" class="form-label">Pricing</label>
                <select class="form-select" id="durationType" required>
                  <option value="hour">Per hour</option>
                  <option value="day">Per day</option>
                  <option value="week">Per week</option>
                  <option value="month">Per month</option>
                </select>
              </div>
              <div class="alert alert-info mt-3 mb-0 small">
                <i class="bi bi-info-circle me-2"></i>Request will be sent for
                approval. We’ll confirm once approved.
              </div>
            </form>
          </div>
          <div class="modal-footer av-modal-footer">
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="submit" form="bookingForm" class="btn btn-primary">
              <i class="bi bi-check-lg me-2"></i>Submit booking
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/script.js"></script>
    <script>
      (function () {
        var DEFAULT_IMG = "../images/my24_gr86-trueno-edition_001.webp";

        function render() {
          var cars = JSON.parse(localStorage.getItem("cars") || "[]");

          /* ✅ Ensure every car has permanent ID */
          for (var i = 0; i < cars.length; i++) {
            if (!cars[i].id) {
              cars[i].id = Date.now() + i;
            }
          }

          /* ✅ Save back IDs */
          localStorage.setItem("cars", JSON.stringify(cars));

          var available = cars.filter(function (c) {
            return c.status !== "rented";
          });

          var container = document.getElementById("availableCars");
          var countEl = document.getElementById("avCarsCountNum");

          if (countEl) countEl.textContent = available.length;

          if (available.length === 0) {
            container.innerHTML =
              '<div class="col-12">' +
              '<div class="av-empty">' +
              '<i class="bi bi-car-front av-empty-icon" aria-hidden="true"></i>' +
              '<h2 class="av-empty-title">No cars available</h2>' +
              '<p class="av-empty-text">Check back later or contact support.</p>' +
              '<a href="user-dashboard.html" class="btn btn-primary av-empty-btn">Back to dashboard</a>' +
              "</div>" +
              "</div>";
            return;
          }

          var html = "";

          for (var i = 0; i < available.length; i++) {
            var car = available[i];

            /* ✅ Always use real ID */
            var carId = car.id;

            var imgSrc = car.image || DEFAULT_IMG;

            var priceDay =
              car.pricePerDay != null ? car.pricePerDay : car.pricePerHour;

            html +=
              '<div class="col-12 col-sm-6 col-lg-4">' +
              '<article class="av-card">' +
              '<div class="av-card-image">' +
              '<img src="' +
              escapeAttr(imgSrc) +
              '" alt="' +
              escapeAttr(car.name) +
              '">' +
              '<span class="av-card-badge">Available</span>' +
              '<span class="av-card-type">' +
              escapeHtml(car.type || "Car") +
              "</span>" +
              "</div>" +
              '<div class="av-card-body">' +
              '<h3 class="av-card-title">' +
              escapeHtml(car.name) +
              "</h3>" +
              '<p class="av-card-meta">' +
              escapeHtml(car.model || "") +
              " · " +
              escapeHtml(car.type || "") +
              "</p>" +
              '<p class="av-card-price">From $' +
              Number(priceDay) +
              "<span>/day</span></p>" +
              '<ul class="av-card-prices" aria-label="Rates">' +
              '<li><i class="bi bi-clock"></i> $' +
              (car.pricePerHour || 0) +
              "/hr</li>" +
              '<li><i class="bi bi-calendar-week"></i> $' +
              (car.pricePerWeek || 0) +
              "/wk</li>" +
              '<li><i class="bi bi-calendar-month"></i> $' +
              (car.pricePerMonth || 0) +
              "/mo</li>" +
              "</ul>" +
              '<button type="button" class="btn btn-primary av-card-btn" data-bs-toggle="modal" data-bs-target="#bookingModal" onclick="window.openBookingModal(' +
              carId +
              ')">' +
              '<i class="bi bi-calendar-check me-2"></i>Book now' +
              "</button>" +
              "</div>" +
              "</article>" +
              "</div>";
          }

          container.innerHTML = html;
        }

        function escapeAttr(s) {
          return String(s)
            .replace(/&/g, "&amp;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        }

        function escapeHtml(s) {
          return String(s)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;");
        }

        /* ✅ Booking Modal Loader */
        window.openBookingModal = function (carId) {
          var cars = JSON.parse(localStorage.getItem("cars") || "[]");

          var car = cars.find(function (c) {
            return c.id === Number(carId);
          });

          if (!car) return;

          var nameEl = document.getElementById("bookingCarName");
          var idEl = document.getElementById("bookingCarId");

          if (nameEl) nameEl.textContent = car.name;
          if (idEl) idEl.value = car.id;
        };

        /* ✅ Load Cars */
        document.addEventListener("DOMContentLoaded", render);

        /* ✅ Booking Submit */
        var bookingForm = document.getElementById("bookingForm");

        if (bookingForm) {
          bookingForm.addEventListener("submit", function (e) {
            e.preventDefault();

            var carId = document.getElementById("bookingCarId").value;
            var startDate = document.getElementById("startDate").value;
            var endDate = document.getElementById("endDate").value;
            var duration = document.getElementById("durationType").value;

            if (!carId || !startDate || !endDate) {
              alert("Please fill all fields");
              return;
            }

            var user = JSON.parse(localStorage.getItem("currentUser"));

            if (!user) {
              alert("Please login first");
              return;
            }

            var bookings = JSON.parse(localStorage.getItem("bookings") || "[]");

            var newBooking = {
              id: Date.now(),
              carId: Number(carId),
              userId: user.id,
              startDate: startDate,
              endDate: endDate,
              duration: duration,
              status: "pending",
            };

            bookings.push(newBooking);

            localStorage.setItem("bookings", JSON.stringify(bookings));

            alert("Booking request sent!");

            bookingForm.reset();

            var modalEl = document.getElementById("bookingModal");
            var modal = bootstrap.Modal.getInstance(modalEl);

            if (modal) modal.hide();
          });
        }
      })();
    </script>
  </body>
</html>
